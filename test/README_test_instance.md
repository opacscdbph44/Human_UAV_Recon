# 算例测试说明

## 测试文件：test_instance.py

这个测试文件用于验证算例的生成、保存、读取和绘制功能，以及新增的需求点分组功能。

## 运行测试

在项目根目录下运行：

```bash
python -m test.test_instance
```

或者：

```bash
cd test
python test_instance.py
```

## 测试内容

### 测试1: 基本算例生成（不分组）
- 生成包含20个需求点的基本算例
- 分组方式：`none`（所有需求点在同一组）
- 验证算例基本信息和分组数据结构

### 测试2: K-means聚类分组
- 生成包含30个需求点的算例
- 使用K-means算法将需求点分为5组
- 验证聚类结果和分组质量

### 测试3: 网格分组
- 生成包含36个需求点的算例
- 使用3×3网格划分需求点
- 验证网格分组的均匀性

### 测试4: 距离阈值分组
- 生成包含25个需求点的算例
- 使用并查集算法，距离小于200的点合并为同一组
- 验证基于距离的分组结果

### 测试5: 算例保存和读取
- 将算例保存为JSON文件
- 从文件读取算例
- 验证数据一致性（包括分组信息）

### 测试6: 算例属性和方法
- 测试算例的各种属性访问
- 验证矩阵计算结果
- 测试to_dict方法

## 测试输出

测试运行后会：

1. **在控制台输出**详细的测试信息，包括：
   - 每个测试的执行状态
   - 分组信息（group_id和group_sets）
   - 各项验证结果

2. **生成算例文件**保存在 `data/Instances/` 目录下：
   ```
   data/Instances/TSPLIB-berlin52/D{demand_num}/
   ├── {timestamp}.json          # 算例JSON文件
   └── figures/
       └── instance_*.jpg         # 算例可视化图
   ```

3. **生成图形文件**：
   - 每个测试都会生成对应的算例可视化图
   - 图中会显示基地、需求点（区分可达/不可达）
   - 颜色编码展示不同的节点类型

## 预期结果

成功运行测试后，你会看到类似的输出：

```
################################################################################
#                              算例测试套件                              #
################################################################################

================================================================================
测试1: 基本算例生成（不分组）
================================================================================

算例名称: TSPLIB-berlin52
基地数量: 1
需求点数量: 20
总节点数: 21

分组信息 (group_id): (-1, 0, 0, 0, ..., 0)
分组集合 (group_sets): {0: {1, 2, 3, ..., 20}}

✓ 测试1通过：算例已生成并保存到 data/Instances/...

...

================================================================================
测试总结
================================================================================
✓ 所有测试通过！

分组功能验证:
  ✓ 不分组 (none): 1个组
  ✓ K-means分组: 5个组
  ✓ 网格分组: 9个组
  ✓ 距离阈值分组: X个组（动态）

核心功能验证:
  ✓ 算例生成
  ✓ 算例保存
  ✓ 算例读取
  ✓ 算例绘制
  ✓ 分组功能
  ✓ 数据一致性
```

## 故障排除

### 问题1: 找不到tsp文件
**错误**: `FileNotFoundError: 指定的.tsp算例文件不存在`

**解决**: 确保 `data/ALL_tsp_file/berlin52.tsp` 文件存在

### 问题2: 导入错误
**错误**: `ModuleNotFoundError: No module named 'src'`

**解决**: 确保在项目根目录运行测试，或将项目根目录添加到PYTHONPATH

### 问题3: sklearn未安装
**错误**: `ModuleNotFoundError: No module named 'sklearn'`

**解决**: 
```bash
pip install scikit-learn
```

## 自定义测试

你可以修改测试参数来测试不同的配置：

```python
# 修改需求点数量
"demand_num": 50,

# 修改分组数量
"num_groups": 10,

# 修改网格尺寸
"grid_size": [4, 4],

# 修改距离阈值
"distance_threshold": 150.0,
```

## 扩展测试

如需添加新的测试用例，可以参考现有测试函数的结构：

```python
def test_custom_scenario():
    """自定义测试场景"""
    print("\n" + "="*80)
    print("测试X: 自定义场景描述")
    print("="*80)
    
    # 创建配置
    config = Config.from_dict({...})
    
    # 生成算例
    instance = create_by_tsp(config, save_folder, save_file=True)
    
    # 执行验证
    assert condition, "错误信息"
    
    # 输出结果
    print(f"\n✓ 测试X通过")
    return instance
```

## 注意事项

1. **首次运行**可能需要较长时间，因为需要读取TSP文件和生成多个算例
2. **生成的文件**会保存在本地，注意磁盘空间
3. **随机性**：某些测试使用随机选择，每次运行结果可能略有不同
4. **图形生成**需要matplotlib支持中文，如果中文显示异常，请配置字体

## 相关文档

- [算例生成文档](../docs/instance_creation.md)
- [分组功能说明](../docs/grouping_feature.md)
- [配置参数说明](../docs/config_parameters.md)
